# PII Detection Agent - Google Cloud Run Deployment
#
# This service definition deploys the PII Detection Agent
# as part of the LLM-Shield unified GCP service.
#
# Deploy:
#   gcloud run deploy pii-detection-agent --source .

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: pii-detection-agent
  labels:
    cloud.googleapis.com/location: us-central1
    app: llm-shield
    component: pii-detection-agent
    classification: detection-only
  annotations:
    run.googleapis.com/description: "PII Detection Agent - Detects PII in content (DETECTION_ONLY)"
    run.googleapis.com/ingress: internal-and-cloud-load-balancing
    run.googleapis.com/execution-environment: gen2
spec:
  template:
    metadata:
      annotations:
        # Autoscaling configuration
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "100"
        run.googleapis.com/cpu-throttling: "false"
        run.googleapis.com/startup-cpu-boost: "true"
    spec:
      containerConcurrency: 100
      timeoutSeconds: 30
      serviceAccountName: llm-shield-agent@PROJECT_ID.iam.gserviceaccount.com
      containers:
        - name: pii-detection-agent
          image: gcr.io/PROJECT_ID/llm-shield/pii-detection-agent:latest
          ports:
            - containerPort: 8080
              name: http1
          env:
            - name: NODE_ENV
              value: production
            - name: RUVECTOR_SERVICE_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: llm-shield-secrets
                  key: ruvector-endpoint
            - name: LLM_OBSERVATORY_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: llm-shield-secrets
                  key: observatory-endpoint
            - name: TELEMETRY_ENABLED
              value: "true"
          resources:
            limits:
              cpu: "2"
              memory: 1Gi
            requests:
              cpu: "1"
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            failureThreshold: 30
            periodSeconds: 2
